const STORAGE_KEY='proTaskManagerState_v1';const defaultState={theme:'dark',topics:{},tasks:[],selectedTopicId:null,selectedSubtopicId:null};let state=loadState();function loadState(){const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return structuredClone(defaultState);try{const parsed=JSON.parse(raw);return{...structuredClone(defaultState),...parsed};}catch(e){console.error('Failed to parse state:',e);return structuredClone(defaultState);}}function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}catch(e){console.error('Failed to save state:',e);}}function addTopic(topicName,color='#4f46e5'){const topicId=topicName.toLowerCase().replace(/\s+/g,'-');if(state.topics[topicId]){alert('Topic already exists!');return false;}state.topics[topicId]={name:topicName,color:color,subtopics:{}};saveState();return topicId;}function addSubtopic(topicId,subtopicName){if(!state.topics[topicId]){console.error('Topic not found');return false;}const subtopicId=subtopicName.toLowerCase().replace(/\s+/g,'-');if(state.topics[topicId].subtopics[subtopicId]){alert('Subtopic already exists!');return false;}state.topics[topicId].subtopics[subtopicId]={name:subtopicName,completed:0,total:0};saveState();return subtopicId;}function addTask({title,topicId,subtopicId,dueDate}){const task={id:crypto.randomUUID(),title,done:false,topicId,subtopicId,dueDate:dueDate||null,completedAt:null,createdAt:new Date().toISOString()};state.tasks.push(task);if(state.topics[topicId]&&state.topics[topicId].subtopics[subtopicId]){state.topics[topicId].subtopics[subtopicId].total++;}saveState();return task;}function toggleTaskDone(taskId){const task=state.tasks.find(t=>t.id===taskId);if(!task)return;const topic=state.topics[task.topicId];const sub=topic.subtopics[task.subtopicId];if(task.done){task.done=false;sub.completed=Math.max(0,sub.completed-1);task.completedAt=null;}else{task.done=true;sub.completed++;task.completedAt=new Date().toISOString();}saveState();}function deleteTask(taskId){const task=state.tasks.find(t=>t.id===taskId);if(!task)return;const topic=state.topics[task.topicId];const sub=topic.subtopics[task.subtopicId];if(task.done){sub.completed=Math.max(0,sub.completed-1);}sub.total=Math.max(0,sub.total-1);state.tasks=state.tasks.filter(t=>t.id!==taskId);saveState();}function getGlobalStats(){const total=state.tasks.length;const done=state.tasks.filter(t=>t.done).length;const percent=total?Math.round((done/total)*100):0;return{total,done,pending:total-done,percent};}function getTopicStats(topicId){const topic=state.topics[topicId];if(!topic)return{total:0,done:0,pending:0,percent:0};let topicTotal=0;let topicDone=0;Object.values(topic.subtopics).forEach(sub=>{topicTotal+=sub.total;topicDone+=sub.completed;});const percent=topicTotal?Math.round((topicDone/topicTotal)*100):0;return{total:topicTotal,done:topicDone,pending:topicTotal-topicDone,percent};}function getSubtopicStats(topicId,subId){const sub=state.topics[topicId].subtopics[subId];const percent=sub.total?Math.round((sub.completed/sub.total)*100):0;return{...sub,percent};}
